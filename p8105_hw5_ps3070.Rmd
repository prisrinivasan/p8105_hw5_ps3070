---
title: "p8105_hw5_ps3070"
output: html_document
editor_options: 
  chunk_output_type: inline
---


```{r}
library(tidyverse)
library(knitr)
```

## Problem 1
```{r iris data}
set.seed(10)

iris_with_missing = iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))

is.list(iris_with_missing) #confirmed that it is a list
```

There are two cases to address:

For numeric variables, you should fill in missing values with the mean of non-missing values

For character variables, you should fill in missing values with "virginica"

Write a function that takes a vector as an argument; replaces missing values using the rules defined above; and returns the resulting vector. Apply this function to the columns of iris_with_missing using a map statement.


```{r}
replace_iris_missing = function(a) {
  if (is.numeric(a)) {
    b = mean(a, na.rm = TRUE) #creating new variable for means
    a = replace(a, is.na(a), b) #replacing na values in a with means from b
  } else if (is.character(a)) {
    a = replace(a, is.na(a), "virginica") #replacing character na values
  }
}

output = map_df(iris_with_missing, replace_iris_missing) #maps function to each vector 

output #to check that it worked

head(output) %>% 
  kable()
```

## Problem 2

This dataset contains data from a longitudinal study that included a control arm and an experimental arm. Data for each participant is included in a separate file, and file names include the subject ID and arm.

Create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time:

Start with a dataframe containing all file names; the list.files function will help

```{r make tibble of file names}
names = tibble(
  file_names = list.files(path = "./data") #creating vector file_names
  )

names #created a df with file names called names
```

There are `r names %>% filter(grepl("con", pull(names, file_names))) %>% nrow()` patients in the control arm and 
`r names %>% filter(grepl("exp", pull(names, file_names))) %>% nrow()` patients in the experimental arm. These file names are now stored in one column in the `names` data frame.

```{r function to get data from "data" directory}
get_data = function(x) {
  
  {directory = "./data/"
  data = read.csv(paste(directory, x, sep = ""))}
  
  return(data)
}
```

Iterate over file names and read in data for each subject using purrr::map and saving the result as a new variable in the dataframe

Tidy the result; manipulate file names to include control arm and subject ID, make sure weekly observations are “tidy”, and do any other tidying that’s necessary

```{r}
tidy_df = names %>% 
  mutate(obs = map(file_names, get_data)) %>% 
  unnest(obs) %>%
  janitor::clean_names() %>% 
  separate(file_names, into = c("arm", "subject"), sep = "_") %>%
  mutate(subject = str_replace(subject, ".csv", "")) %>% 
  gather(key = week, value = meas, week_1:week_8) %>%
  separate(week, into = c("extra", "week"), sep = "_") %>% 
  select(-extra) %>% 
  mutate(arm = as.character(arm),
         subject = as.factor(subject),
         week = as.numeric(week)) %>% 
  arrange(arm)

head(tidy_df) %>%
  kable(format = "html", caption = "Study Measurements") #tibble sorted by week
```


Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.

```{r spaghetti plot}
files_plot = tidy_df %>% 
  ggplot(aes(x = week, y = meas, color = subject, group = arm)) +
  geom_line() +
  facet_grid(~arm) +
  labs(x = "Week",
       y = "Measurement")

files_plot
```

## Problem 3

First, I set the following design elements:
```{r set design elements}
n = 30
x_i1 = rnorm(n, 0, 1) #x draws from standard normal dist so mean is 0 and sd is 1
beta0 = 2
sd = 50 

beta1 = 0
```

Then, I am generating 10,000 datasets from the following model:

$$ y_i = \beta_0 + \beta_1 x_{i1} + \epsilon_{i} $$

with $\epsilon_{i} ∼ N[0,\sigma^2]$.

With an alpha of 0.05 (5% significance level), I am testing:
$$ H : \beta_1 = 0 $$
_Hint: to obtain the estimate and p-value, use `broom::tidy` to clean the output of `lm`._ 

```{r}
sim = function(n = 30, beta0 = 2, beta1 = 0) {
  
  sim_data = tibble(
    x_i1 = rnorm(n, mean = 0, sd = 1),
    y = beta0 + beta1 * x_i1 + rnorm(n, 0, 50)
  )
  
  ls_fit = lm(y ~ x_i1, data = sim_data) %>% 
    broom::tidy()
}

betas = tibble(beta1 = 0:6) 

beta1_sim = map_df(betas, sim) #maps function to each vector 

broom::glance(ls_fit)

simulation =
  rerun(10000, sim(30, 2, 0)) %>% 
  bind_rows()

```

```{r FROM JEFFS CODE}

simulation %>% 
  pivot_longer(
    beta1_hat:p_value,
    names_to = "parameter", 
    values_to = "estimate") %>% 
  group_by(parameter) %>% 
  summarize(emp_mean = mean(estimate),
            emp_var = var(estimate)) %>% 
  knitr::kable(digits = 3)
```

